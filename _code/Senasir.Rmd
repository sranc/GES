---
title: "SENASIR"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    css: styles.css
---

```{r setup, include=FALSE}
library(flexdashboard)
pacman::p_load(
  tidyverse,
  readxl,
  dplyr,
  sparklyr,
  ggplot2,
  plotly,
  DT,
  scales
)

reparto_cant <- read_excel("../_data/reparto/temporal/EstadisticaSistemaRepartoBeneficiario2023.xlsx")
reparto_mont <- read_excel("../_data/reparto/temporal/EstadisticaSistemaRepartoMontos2023.xlsx")
DIC_1 <- "DIC_2022"
DIC_2 <- "DIC_2021"
orden <- c(DIC_2, DIC_1, "ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV","AGUI", "DIC")

generar_data <- function(data, amount = FALSE){
  
  reparto_cant<- data %>% 
    select(gestion, clase, tipo, tipo_renta, ENE:DIC_2) %>% 
    pivot_longer(cols = c(ENE:DIC_2), names_to = "mes", values_to = "cantidad") %>%
    mutate(mes = case_when(
      mes == "DIC_1" ~ DIC_1,
      mes == "DIC_2" ~ DIC_2,
      TRUE ~ mes
    ))
  
  data <- reparto_cant %>% 
    filter(clase == "Sexo" & (tipo == "Titular" | tipo == "Derechohabiente")) %>% 
    group_by(mes,tipo) %>% 
    summarise(cantidad = sum(cantidad)) %>% 
    arrange(desc(tipo)) %>% 
    mutate(mes = factor(mes, levels = orden)) %>%
    filter(cantidad != 0)

  if(amount==TRUE) {
    data_before <- data %>% 
      filter(mes == DIC_1 | mes == DIC_2)
    data_actual <- data %>% 
      filter(mes != DIC_2) %>% 
      filter(mes != DIC_1) %>%
      group_by(tipo) %>%
      arrange(mes, tipo) %>%
      mutate(total_mes = cumsum(cantidad)) %>% 
      select(mes,tipo,cantidad = total_mes)
    data <- bind_rows(data_before,data_actual)%>%
      mutate(across(c(cantidad), ~ round(. / 1e6)))
  } 
  
  totales <- data %>%
    group_by(mes) %>%
    summarise(total = sum(cantidad)) 
  
  data_table <- merge(data, totales, by = "mes") 
  
  return(list("data_table" = data_table, "totales" = totales))
}

genera_data_table <- function(data){
  tabla_p <- data$data_table %>% 
    select(TIPO = tipo, mes, cantidad) %>% 
    mutate(cantidad = format(cantidad, big.mark = ".", decimal.mark = ",")) %>%
    pivot_wider(names_from = mes, values_from = cantidad) %>% 
    arrange(desc(TIPO)) %>%
    bind_rows(
      data$totales %>% 
        filter(total != 0) %>% 
        mutate(total = format(total, big.mark = ".", decimal.mark = ",")) %>%
        pivot_wider(names_from = mes, values_from = total) %>%
        mutate(TIPO = "Total")
    )
  return(generar_tabla(tabla_p))
}

genera_data_pie <- function(data, title){
  colors <- c('#FFC502','#073767')
  mes_fil <- data$data_table %>% 
    slice(n()) %>% 
    pull(mes) %>%
    as.character()
  
  torta <- data$data_table %>% 
    filter(mes == mes_fil) %>% 
    group_by(TIPO = tipo) %>% 
    summarise(cantidad = sum(cantidad))
  title <- paste(title, " - ", mes_selector(mes_fil))
  
  grafico <- generar_grafico_2(data = torta, label = "TIPO", value = "cantidad", hole = 0.4, colors = colors, title = title)
  
  return(grafico)
}

mes_selector <- function(mes){
  mensaje <- switch (mes,
    "ENE" = "Enero",
    "FEB" = "Febrero",
    "MAR" = "Marzo",
    "ABR" = "Abril",
    "MAY" = "Mayo",
    "JUN" = "Junio",
    "JUL" = "Julio",
    "AGO" = "Agosto",
    "SEP" = "Septiembre",
    "OCT" = "Octubre",
    "NOV" = "Noviembre",
    "AGUI" = "Aguinaldo",
    "DIC" = "Diciembre",
  )
}

generar_grafico <- function(data, data_2 = data, bar_color, name_bar, name_line, line_color, line_text_color, x_var, y1_var, y2_var, tipo_var, titulo, ejex, ejey, ejey_2, two_data = FALSE) {
  # Crear el gráfico de barras
  bar_plot <- plot_ly(
    data = data,
    name = if (two_data) name_bar else NULL,
    x = ~get(x_var),
    y = ~get(y1_var),
    color = if (!two_data) {~get(tipo_var)} else NULL,
    colors = if (!two_data) bar_color else NULL,
    marker = if (two_data) list(color = bar_color) else NULL,
    type = "bar",
    text = ~paste(scales::number(get(y1_var), big.mark = ".", decimal.mark = ",", accuracy = 1)),
    textfont = list(size = 16, color = c()),
    insidetextanchor = "middle",
    hoverinfo = "text"
  ) %>% 
    layout(
      barmode = "stack",
      showlegend = TRUE,
      shapes = list(
        list(
          type = "line",
          x0 = 1.5,
          x1 = 1.5,
          y0 = 0,
          y1 = 1,
          yref = "paper",
          line = list(color = "red", dash = "dash", width = 3)
        )
      )
    )
  if (two_data) 
    {
      ay <- list(
        tickfont = list(color = "black"),
        overlaying = "y",
        side = "right",
        title = ejey_2)
    }
  
  font_prop <- list(
    color = "black",
    size = 18
  )
  
  # Crear el gráfico de líneas y puntos
  line_plot <- bar_plot %>% 
    add_trace(
      data = data_2,
      name = if (two_data) name_line else NULL,
      x = ~get(x_var),
      y = ~get(y2_var),
      yaxis = if (two_data) "y2" else NULL, 
      type = "scatter",
      mode = "lines+markers",
      line = list(color = line_color, width = 4.3),
      marker = list(color = line_color, size = 15, symbol = "diamond"),
      text = ~paste(scales::number(get(y2_var), big.mark = ".", decimal.mark = ",", accuracy = 1)),
      textposition = "top center",  
      textfont = list(size = 15, color = line_text_color),
      hoverinfo = "text",
      showlegend = two_data
    ) %>% 
    layout(
      title = list(text = titulo, font = font_prop, y = 0.965, x = 0.5, xanchor = 'center', yanchor =  'top'),
      yaxis2 = if (two_data) ay else NULL,
      xaxis = list(title = ejex),
      yaxis = list(title = ejey),
      legend = if (two_data) list(x = 1.05, y = 1, 
                    traceorder = 'normal', 
                    orientation = 'v', 
                    xanchor = 'left',
                    yanchor = 'top') else NULL
    ) %>%
    layout(
      xaxis = list(
        zerolinecolor = '#ffff',
        zerolinewidth = 2,
        gridcolor = 'ffff'),
      yaxis = list(
        zerolinecolor = '#ffff',
        zerolinewidth = 2,
        gridcolor = 'ffff')
    ) %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = c("lasso2d","select2d","resetScale2d","hoverCompareCartesian","hoverClosest3d"),
      modeBarButtonsToAdd =c("drawline"),
      locale = "es"
    )
  
  return(line_plot)
}

generar_tabla <- function(tabla)
  {
  tabla <- datatable(tabla,
                     options = list(
                       searching = FALSE,
                       paging = FALSE,
                       info = FALSE,
                       initComplete = JS('
                       function(settings, json) {
                       $("table.dataTable th").css("font-size", "10px");
                       $("table.dataTable td").css("font-size", "14px");
                       }
                                         ')
                       )
                     )
  return(tabla)
}

generar_grafico_2 <- function(data, label, value, hole, colors, title){
  plot_ly(data = data,labels=~get(label),values=~get(value),type = "pie", hole=hole,
          marker = list(colors = colors,
                        line = list(color = '#FFFFFF', width = 2))) %>% 
    layout(
      title = title,
      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE)
      ) %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = c("lasso2d","select2d","resetScale2d","hoverCompareCartesian","hoverClosest3d"),
      locale = "es"
      )
}
```

Dashboard
=======================================================================

Row {data-height=150}
-----------------------------------------------------------------------

### menu 

Row {data-height=550}
-----------------------------------------------------------------------

### grafico

Row {data-height=250}
-----------------------------------------------------------------------

### dato
### dato 2
### dato 3

Sistema Reparto {data-navmenu="Reparto"}
=======================================================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)

Row
-----------------------------------------------------------------------

### 

<img src="../_data/Reparto.png" alt="Sistema Reparto" style="max-width: 100%;">

Beneficiarios {data-navmenu="Reparto" .hidden}
=======================================================================
```{r}
beneficiario <- generar_data(data = reparto_cant)
```

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)

Row {data-height=650}
-----------------------------------------------------------------------

### 

```{r}
generar_grafico(data = beneficiario$data_table,x_var = "mes",
                                      bar_color = c("Derechohabiente" = '#FFC502', "Titular" = "#073767"),
                                      line_color = "#525659", line_text_color = "black",
                                      y1_var = "cantidad", y2_var = "total", tipo_var = "tipo", 
                                      titulo = "Nro DE BENEFICIARIOS DE RENTAS Y PENSIONES VITALICIAS<br>DEL SISTEMA DE REPARTO",
                                      ejex = "Mes", ejey = "<b>Cantidad</b> beneficiario")
```

Row {data-height=350}
-----------------------------------------------------------------------

### {data-width=650}

```{r}
genera_data_table(beneficiario)
```

###  {data-width=350}

```{r}
genera_data_pie(data = beneficiario, title = "Titular vs Derechohabiente")
```

Montos {data-navmenu="Reparto" .hidden}
=======================================================================

```{r}
monto <- generar_data(data = reparto_mont, amount = TRUE) 
```

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)

Row {data-height=650}
-----------------------------------------------------------------------

### 

```{r}
generar_grafico(data = monto$data_table,x_var = "mes",
                                      bar_color = c("Derechohabiente" = "#FFC502", "Titular" = "#073767"),
                                      line_color = "#525659", line_text_color = "black",
                                      y1_var = "cantidad", y2_var = "total", tipo_var = "tipo", 
                                      titulo = "MONTO DESEMBOLSADO DE RENTAS Y PENSIONES VITALICIAS<br>DEL SISTEMA DE REPARTO",
                                      ejex = "Mes", ejey = "<b>Monto</b> (en millones de Bs)")
```
Row {data-height=350}
-----------------------------------------------------------------------

### {data-width=650}
```{r}
genera_data_table(monto)
```

###  {data-width=350}

```{r}
genera_data_pie(data = monto, title = "Titular vs Derechohabiente")
```

Montobeneficiario {data-navmenu="Reparto" .hidden}
=======================================================================

```{r}
datos_combinados <- rbind(
  transform(beneficiario$totales, tipo = "Cantidad"),
  transform(monto$totales, tipo = "Monto")
)
```

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)

Row {data-height=650}
-----------------------------------------------------------------------

### 

```{r}
generar_grafico(data = subset(datos_combinados, tipo == "Cantidad"),x_var = "mes",
                                      data_2 = subset(datos_combinados, tipo == "Monto"),
                                      name_bar = "Cantidad", name_line = "Monto",
                                      bar_color = "#073767",
                                      line_color = "#FFC502", line_text_color = "#FFC502",
                                      y1_var = "total", y2_var = "total", tipo_var = "tipo", 
                                      titulo = "MONTO DESEMBOLSADO Y N DE BENEFICIARIOS<br>DEL SISTEMA DE REPARTO",
                                      ejex = "Mes", ejey = "<b>Cantidad</b> beneficiario", 
                                      ejey_2 = "<b>Monto</b> (en millones de Bs)", two_data = TRUE)

```

Row {data-height=350}
-----------------------------------------------------------------------

### {data-width=650}
```{r}
table_combinados <- datos_combinados %>%
  mutate(total = format(total, big.mark = ".", decimal.mark = ",")) %>% 
  pivot_wider(names_from = mes, values_from = total) %>%
  rename(TIPO = tipo)

generar_tabla(table_combinados)
```

###  {data-width=350}

```{r}

```

Genero {data-navmenu="Reparto" .hidden}
=======================================================================

```{r}

```

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)

Row {data-height=650}
-----------------------------------------------------------------------

### 

```{r}

```
Row {data-height=350}
-----------------------------------------------------------------------

### {data-width=650}
```{r}

```

###  {data-width=350}

```{r}

```

Departamento {data-navmenu="Reparto" .hidden}
=======================================================================

```{r}

```

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)

Row {data-height=650}
-----------------------------------------------------------------------

### 

```{r}

```
Row {data-height=350}
-----------------------------------------------------------------------

### {data-width=650}
```{r}

```

###  {data-width=350}

```{r}

```

Regular {data-navmenu="Reparto" .hidden}
=======================================================================

```{r}

```

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)


Row {data-height=650}
-----------------------------------------------------------------------

### 

```{r}

```
Row {data-height=350}
-----------------------------------------------------------------------

### {data-width=650}
```{r}

```

###  {data-width=350}

```{r}

```

Domicilio {data-navmenu="Reparto" .hidden}
=======================================================================

```{r}

```

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)

Row {data-height=650}
-----------------------------------------------------------------------

### 

```{r}

```
Row {data-height=350}
-----------------------------------------------------------------------

### {data-width=650}
```{r}

```

###  {data-width=350}

```{r}

```

Abono {data-navmenu="Reparto" .hidden}
=======================================================================

```{r}

```

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)

Row {data-height=650}
-----------------------------------------------------------------------

### 

```{r}

```
Row {data-height=350}
-----------------------------------------------------------------------

### {data-width=650}
```{r}

```

###  {data-width=350}

```{r}

```

Poder {data-navmenu="Reparto" .hidden}
=======================================================================

```{r}

```

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)

Row {data-height=650}
-----------------------------------------------------------------------

### 

```{r}

```
Row {data-height=350}
-----------------------------------------------------------------------

### {data-width=650}
```{r}

```

###  {data-width=350}

```{r}

```

Autorizacion {data-navmenu="Reparto" .hidden}
=======================================================================

```{r}

```

Sidebar {.sidebar}
-----------------------------------------------------------------------

[Número Beneficiarios](#beneficiarios)
[Monto Desembolsado](#montos)
[Monto vs beneficiario](#montobeneficiario)
[N° beneficiario segun género](#genero)
[N° beneficiario por departamento](#departamento)
[Planilla de pago regular](#regular)
[planillas de pago a domicilio](#domicilio)
[Planillas abono a cuenta](#abono)
[planillas pago con poder](#poder)
[Formulario de autorización de pago (ANEXO 15) ](#autorizacion)

Row {data-height=650}
-----------------------------------------------------------------------

### 

```{r}

```
Row {data-height=350}
-----------------------------------------------------------------------

### {data-width=650}
```{r}

```

###  {data-width=350}

```{r}

```
